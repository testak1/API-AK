<html>
  <head>
    <title>Model Image Upload Tool</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        max-width: 600px;
        margin: 0 auto;
        padding: 20px;
      }
      .form-group {
        margin-bottom: 15px;
      }
      label {
        display: block;
        margin-bottom: 5px;
      }
      input,
      select {
        width: 100%;
        padding: 8px;
        box-sizing: border-box;
      }
      button {
        background: #4285f4;
        color: white;
        border: none;
        padding: 10px 15px;
        cursor: pointer;
      }
      button:disabled {
        background: #cccccc;
      }
      #preview {
        max-width: 200px;
        max-height: 200px;
        margin-top: 10px;
      }
      #status {
        margin-top: 15px;
        padding: 10px;
        border-radius: 4px;
      }
      .success {
        background: #e6ffed;
        color: #1a7321;
      }
      .error {
        background: #ffebee;
        color: #c62828;
      }
    </style>
  </head>
  <body>
    <h1>Model Image Upload Tool</h1>

    <div class="form-group">
      <label for="token">Sanity Token:</label>
      <input type="password" id="token" placeholder="Paste your token" />
    </div>

    <div class="form-group">
      <label for="brand">Brand:</label>
      <input type="text" id="brand" placeholder="e.g. Audi" />
    </div>

    <div class="form-group">
      <label for="modelName">Model Name:</label>
      <input type="text" id="modelName" placeholder="e.g. Q8" />
    </div>

    <div class="form-group">
      <label for="modelId">Model ID:</label>
      <input type="text" id="modelId" placeholder="e.g. 881" />
    </div>

    <div class="form-group">
      <label for="imageUpload">PNG Image:</label>
      <input type="file" id="imageUpload" accept=".png" />
      <img id="preview" style="display: none" />
    </div>

    <button id="uploadBtn" disabled>Upload to Sanity</button>

    <div id="status"></div>

    <script>
      // Configuration - Update these with your Sanity details
      const SANITY_CONFIG = {
        projectId: "wensahkh",
        dataset: "production",
        token: "", // Provide via input below
        apiVersion: "2025-04-23",
      };

      // DOM elements
      const brandInput = document.getElementById("brand");
      const modelNameInput = document.getElementById("modelName");
      const modelIdInput = document.getElementById("modelId");
      const tokenInput = document.getElementById("token");
      const imageUpload = document.getElementById("imageUpload");
      const preview = document.getElementById("preview");
      const uploadBtn = document.getElementById("uploadBtn");
      const statusDiv = document.getElementById("status");

      // Preview uploaded image
      imageUpload.addEventListener("change", function (e) {
        const file = e.target.files[0];
        if (file && file.type === "image/png") {
          const reader = new FileReader();
          reader.onload = function (event) {
            preview.src = event.target.result;
            preview.style.display = "block";
            uploadBtn.disabled = false;
          };
          reader.readAsDataURL(file);
        } else {
          showStatus("Please select a PNG image", "error");
          uploadBtn.disabled = true;
        }
      });

      // Upload to Sanity
      uploadBtn.addEventListener("click", async function () {
        const brand = brandInput.value.trim();
        const modelName = modelNameInput.value.trim();
        const modelId = modelIdInput.value.trim();
        const token = tokenInput.value.trim();
        const file = imageUpload.files[0];

        if (!token) {
          showStatus("Please provide your Sanity token", "error");
          return;
        }

        if (!brand || !modelName || !modelId || !file) {
          showStatus("Please fill all fields", "error");
          return;
        }

        try {
          showStatus("Uploading...");
          uploadBtn.disabled = true;

          SANITY_CONFIG.token = token;

          // 1. Upload image to Sanity
          const imageUrl = await uploadImageToSanity(file, brand, modelName);

          // 2. Create new model entry
          const newModel = {
            name: modelName,
            id: modelId,
            image_url: imageUrl,
            brand: brand,
          };

          // 3. Save to backend JSON file
          await fetch("/api/add-model", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(newModel),
          });

          showStatus(
            `Success! New model added:<br>
          Brand: ${brand}<br>
          Model: ${modelName}<br>
          ID: ${modelId}<br>
          Image URL: ${imageUrl}`,
            "success",
          );

          // Reset form
          brandInput.value = "";
          modelNameInput.value = "";
          modelIdInput.value = "";
          imageUpload.value = "";
          preview.style.display = "none";
          uploadBtn.disabled = true;
        } catch (error) {
          showStatus(`Error: ${error.message}`, "error");
          uploadBtn.disabled = false;
        }
      });

      // Helper function to upload image to Sanity
      async function uploadImageToSanity(file, brand, modelName) {
        const formData = new FormData();
        formData.append(
          "file",
          file,
          `${brand.toLowerCase()}-${modelName.toLowerCase()}.png`,
        );

        const response = await fetch(
          `https://${SANITY_CONFIG.projectId}.api.sanity.io/v${SANITY_CONFIG.apiVersion}/assets/images/${SANITY_CONFIG.dataset}`,
          {
            method: "POST",
            headers: {
              Authorization: `Bearer ${SANITY_CONFIG.token}`,
            },
            body: formData,
          },
        );

        if (!response.ok) {
          throw new Error(`Sanity upload failed: ${response.status}`);
        }

        const result = await response.json();
        return `https://cdn.sanity.io/images/${SANITY_CONFIG.projectId}/${SANITY_CONFIG.dataset}/${result.document._id}.png`;
      }

      // Helper function to show status messages
      function showStatus(message, type = "") {
        statusDiv.textContent = "";
        statusDiv.innerHTML = message;
        statusDiv.className = type;
      }
    </script>

    <!-- Note about file saving -->
    <div
      style="
        margin-top: 30px;
        padding: 10px;
        background: #fff8e1;
        border-left: 4px solid #ffc107;
      "
    >
      <h3>Important Note:</h3>
      <p>
        You must supply a valid Sanity token in the field above. Uploaded models
        are saved via the <code>/api/add-model</code> endpoint which updates
        <code>public/data/all_models.json</code>.
      </p>
    </div>
  </body>
</html>
